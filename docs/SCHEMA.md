# Database Schema

This document describes the database schema for the Live Music Curator application. The database stores information about cities, playlist generation jobs, and user-saved playlists.

## Overview

The application uses PostgreSQL with the following extensions:
- **PostGIS**: For geospatial queries and geography data types
- **pg_trgm**: For fuzzy text search using trigrams

The database consists of three main tables:
1. `cities` - Geographic city data for search and autocomplete
2. `playlist_jobs` - Job queue for playlist generation requests
3. `saved_playlists` - Permanent storage of user-saved playlists

---

## Tables

### `cities`

Stores city data used for location-based searches and autocomplete functionality.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `SERIAL` | PRIMARY KEY | Unique identifier for each city |
| `name` | `VARCHAR(255)` | NOT NULL, UNIQUE | Full city name (e.g., "Austin, TX" or "Austin, Texas") |
| `latitude` | `DECIMAL(9, 6)` | NOT NULL | Latitude coordinate |
| `longitude` | `DECIMAL(9, 6)` | NOT NULL | Longitude coordinate |
| `city` | `VARCHAR(255)` | NULL | City name component (e.g., "Austin") |
| `admin_name` | `VARCHAR(255)` | NULL | Administrative region (e.g., "Texas") |
| `country` | `VARCHAR(255)` | NULL | Country name |
| `population` | `INTEGER` | NULL | City population (used for search ranking) |
| `geography` | `GEOGRAPHY(Point, 4326)` | NULL | PostGIS geography point for spatial queries |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | Timestamp when city was added |

**Indexes:**
- `idx_cities_geography` (GIST index on `geography`) - For fast spatial proximity queries
- `idx_cities_name_trgm` (GIN index on `name` using trigrams) - For fast fuzzy text search
- `idx_cities_population_desc` (B-tree index on `population DESC`) - For ranking cities by population

**Constraints:**
- `cities_name_unique` - Ensures each city name is unique

---

### `playlist_jobs`

Queue table for playlist generation jobs. Tracks the status, inputs, outputs, and progress of each playlist creation request.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `BIGINT` | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY | Unique job identifier |
| `created_at` | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW() | Timestamp when job was created |
| `updated_at` | `TIMESTAMPTZ` | NOT NULL, DEFAULT NOW() | Timestamp when job was last updated (auto-updated via trigger) |
| `status` | `TEXT` | NOT NULL, DEFAULT 'pending' | Job status: `'pending'`, `'building'`, `'complete'`, or `'failed'` |
| `owner_id` | `UUID` | NULL, REFERENCES `auth.users(id)` | User who created the job (NULL for anonymous users) |
| | | | **Job Inputs** |
| `search_city` | `TEXT` | NOT NULL | City name for the search |
| `search_date` | `DATE` | NOT NULL | Target date for events |
| `latitude` | `NUMERIC(9, 6)` | NOT NULL | Latitude for location-based search |
| `longitude` | `NUMERIC(9, 6)` | NOT NULL | Longitude for location-based search |
| `number_of_songs` | `INTEGER` | NOT NULL, DEFAULT 2 | Number of songs to include per artist |
| `excluded_genres` | `TEXT[]` | NULL | Array of genre names to exclude |
| `min_start_time` | `INTEGER` | DEFAULT 0 | Minimum event start time (hours, 0-24) |
| `max_start_time` | `INTEGER` | DEFAULT 24 | Maximum event start time (hours, 0-24) |
| | | | **Job Outputs** |
| `playlist_id` | `TEXT` | NULL | Spotify playlist ID (created when job completes) |
| `error_message` | `TEXT` | NULL | Error message if job failed |
| | | | **Progress Tracking** |
| `log_history` | `TEXT[]` | DEFAULT '{}' | Array of log messages for live activity feed |
| `total_artists` | `INTEGER` | DEFAULT 0 | Total number of artists found |
| `processed_artists` | `INTEGER` | DEFAULT 0 | Number of artists processed so far |
| `events_data` | `JSONB` | DEFAULT '[]' | Array of event objects with venue, tickets, date, image, etc. |

**Indexes:**
- `idx_jobs_status_created_at` (B-tree on `status, created_at`) - For efficiently querying jobs by status
- `idx_playlist_jobs_owner_id` (B-tree on `owner_id`) - For fast retrieval of user's jobs

**Triggers:**
- `on_job_update` - Automatically updates `updated_at` column before any UPDATE

**Notes:**
- Jobs are processed asynchronously by worker processes
- The `status` field tracks the job lifecycle from creation to completion
- `log_history`, `total_artists`, and `processed_artists` enable live progress tracking in the UI
- `events_data` stores the rich event information (venue, ticket links, dates, images) for the Concert List UI

---

### `saved_playlists`

Permanent storage for playlists that users have explicitly saved to their library. This decouples the "User Library" from the ephemeral "Job History" in `playlist_jobs`.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | `BIGINT` | PRIMARY KEY, GENERATED BY DEFAULT AS IDENTITY | Unique identifier for saved playlist |
| `user_id` | `UUID` | NOT NULL, REFERENCES `auth.users(id)` ON DELETE CASCADE | User who owns this playlist |
| `original_job_id` | `BIGINT` | NULL, REFERENCES `playlist_jobs(id)` ON DELETE SET NULL | Reference to original job (optional, for debugging lineage) |
| | | | **Core Metadata** |
| `spotify_playlist_id` | `TEXT` | NOT NULL | Spotify playlist ID |
| `name` | `TEXT` | NOT NULL | Playlist name (e.g., "Austin 12-31-2025 live music") |
| `city_name` | `TEXT` | NOT NULL | City name (e.g., "Austin, TX") |
| `playlist_date` | `DATE` | NOT NULL | Date associated with the playlist |
| | | | **Filter Snapshot** |
| `events_snapshot` | `JSONB` | NOT NULL, DEFAULT '[]' | Event data visible at time of creation (venue, tickets, etc.) |
| `latitude` | `DECIMAL(9, 6)` | NULL | Latitude used for the original search |
| `longitude` | `DECIMAL(9, 6)` | NULL | Longitude used for the original search |
| `min_start_time` | `INTEGER` | DEFAULT 0 | Minimum event start time filter |
| `max_start_time` | `INTEGER` | DEFAULT 24 | Maximum event start time filter |
| `excluded_genres` | `TEXT[]` | NULL | Array of excluded genres |
| | | | **Timestamps** |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW() | When playlist was saved |
| `updated_at` | `TIMESTAMPTZ` | DEFAULT NOW() | Last update timestamp |

**Indexes:**
- `idx_saved_playlists_user` (B-tree on `user_id`) - For fast retrieval of "My Playlists"

**Constraints:**
- `unique_user_job` (UNIQUE on `user_id, original_job_id`) - Prevents saving the same job twice

**Notes:**
- Saved playlists preserve the exact state of events and filters at the time they were saved
- Users can regenerate saved playlists, which updates the playlist in-place while preserving the saved record
- When a user account is deleted, all their saved playlists are automatically deleted (CASCADE)

---

## Database Functions

### `handle_updated_at()`

**Type:** Trigger Function  
**Language:** PL/pgSQL

Automatically updates the `updated_at` column to the current timestamp before any UPDATE operation on tables that use this trigger.

**Usage:**
Applied to `playlist_jobs` table via the `on_job_update` trigger.

---

## Schema Evolution

The database schema has evolved significantly from the original design:

1. **Original schema** (migrations 001-003): Included a `users` table with Spotify authentication and separate `curation_requests` and `curated_artists` tables
2. **Public curator refactor** (migration 004): Removed user authentication, making the service publicly accessible
3. **Cities table** (migrations 005-010): Added city data storage with fuzzy search capabilities
4. **Playlist jobs** (migration 011-023): Replaced `curation_requests` with `playlist_jobs` for better job queue management
5. **User authentication** (migration 024): Re-introduced user association via Supabase Auth (`auth.users`)
6. **Saved playlists** (migrations 025-029): Added persistent user library separate from job history

The current schema supports both anonymous and authenticated users, with optional user-specific features like saved playlists.

---

## Relationships

```
auth.users (Supabase Auth)
  └─> playlist_jobs.owner_id (optional, NULL for anonymous)
  └─> saved_playlists.user_id (required)

playlist_jobs
  └─> saved_playlists.original_job_id (optional reference)
```

---

## Key Design Decisions

1. **Separation of Jobs and Saved Playlists**: Jobs are ephemeral and track the generation process, while saved playlists are permanent user data. This allows users to save playlists without keeping all job history indefinitely.

2. **Geospatial Data**: Using PostGIS `GEOGRAPHY` type enables efficient proximity-based searches for finding nearby cities and events.

3. **Fuzzy Search**: The trigram index on city names allows users to find cities even with typos or partial matches.

4. **Progress Tracking**: The `log_history`, `total_artists`, and `processed_artists` fields enable real-time progress updates in the UI without requiring polling of external APIs.

5. **Event Data Snapshot**: Saving `events_snapshot` in `saved_playlists` preserves the exact events visible when the playlist was created, even if events change or expire later.
